<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Megatech</title><link>https://megate.ch/</link><description>Recent content on Megatech</description><generator>Hugo -- gohugo.io</generator><language>en-US</language><managingEditor>gnomesort@megate.ch (Alexander Rothman)</managingEditor><webMaster>gnomesort@megate.ch (Alexander Rothman)</webMaster><copyright>Â© Alexander Rothman</copyright><lastBuildDate>Thu, 29 Feb 2024 17:25:57 -0800</lastBuildDate><atom:link href="https://megate.ch/index.xml" rel="self" type="application/rss+xml"/><item><title>Godot 3.x Patch for Doomsday Paradise</title><author>gnomesort@megate.ch</author><category>projects</category><link>https://megate.ch/projects/godot_3_x_patch_for_doomsday_paradise/</link><pubDate>Wed, 28 Feb 2024</pubDate><guid>https://megate.ch/projects/godot_3_x_patch_for_doomsday_paradise/</guid><description>&lt;h2 id="introduction">Introduction&lt;/h2>
&lt;p>Last summer (the summer of 2023), I was contracted by &lt;a href="https://www.lemonadeflashbang.com/">Lemonade Flashbang&lt;/a> to
write a patch for the &lt;a href="https://godotengine.org/">Godot&lt;/a> game engine. The patch fixes text display issues in the
simplified Chinese, traditional Chinese, and Japanese localizations of
&lt;a href="https://store.steampowered.com/app/1603420/Doomsday_Paradise/">Doomsday Paradise&lt;/a>. By patching Godot, Lemonade
Flashbang could present its game at &lt;a href="https://bitsummit.org/en/">Bitsummit&lt;/a> last July and launch it on
&lt;a href="https://store.steampowered.com/">Steam&lt;/a> last November.&lt;/p>
&lt;h2 id="the-problem">The Problem&lt;/h2>
&lt;p>Before version 4.0, Godot produced inappropriate line-breaking behavior for CJK text. The inappropriate behavior was
observable using both the &lt;a href="https://docs.godotengine.org/en/3.5/classes/class_label.html">&lt;code>Label&lt;/code>&lt;/a> and
&lt;a href="https://docs.godotengine.org/en/3.5/classes/class_richtextlabel.html">&lt;code>RichTextLabel&lt;/code>&lt;/a> nodes. Unfortunately, in
Godot 3.x, automatic line-breaking is handled differently in &lt;code>Label&lt;/code> and &lt;code>RichTextLabel&lt;/code> nodes. Each node requires a
separate solution (or a large-scale change to its functionality, such as the changes included in 4.0). &lt;code>Label&lt;/code> nodes
break the entire text into a linked list of separable strings. When inserting more text into the list would overflow a
line, Godot inserts a specialized
&lt;a href="https://github.com/gn0mesort/godot/blob/3.5-stable/scene/gui/label.h#L72">&lt;code>WRAPLINE&lt;/code>&lt;/a> element. &lt;code>RichTextLabel&lt;/code> nodes,
on the other hand, use a more complex approach. A Godot 3.x &lt;code>RichTextLabel&lt;/code> node contains a linked list of
&lt;a href="https://github.com/gn0mesort/godot/blob/3.5-stable/scene/gui/rich_text_label.h#L112">&lt;code>RichTextLabel::Item&lt;/code>&lt;/a> objects.
Each &lt;code>Item&lt;/code> represents a formatted segment of the &lt;code>RichTextLabel&lt;/code> node&amp;rsquo;s content. However, not all of the content of a
&lt;code>RichTextLabel&lt;/code> needs to be text. The result is that each &lt;code>Item&lt;/code> may represent the entire text (the simplest case), a
portion of the text, or no text at all. When automatically inserting line breaks into a &lt;code>RichTextLabel&lt;/code>, Godot 3.x
only considers whether or not the text in the current &lt;code>Item&lt;/code> would overflow the current line. This approach works fine
for English text but is a source of many errors for languages using CJK characters.&lt;/p>
&lt;p>To make matters more complex, Godot 3.x&amp;rsquo;s source code exhibits some common issues often found in lower-quality
&lt;span class="nowrap">C++&lt;/span> source code. In both &lt;code>Label&lt;/code> and &lt;code>RichTextLabel&lt;/code> nodes, the method that handles the
automatic line-breaking process is quite long.
&lt;a href="https://github.com/gn0mesort/godot/blob/3.5-stable/scene/gui/rich_text_label.cpp#L143">&lt;code>RichTextLabel::_process_line&lt;/code>&lt;/a>
(the method responsible for automatic line-breaking in &lt;code>RichTextLabel&lt;/code> nodes) is over 700 lines long.
&lt;code>RichTextLabel::_process_line&lt;/code> (the primary offender) also includes several extensive macro definitions. These macros,
such as &lt;a href="https://github.com/gn0mesort/godot/blob/3.5-stable/scene/gui/rich_text_label.cpp#L211">&lt;code>NEW_LINE&lt;/code>&lt;/a>, reduce
the size and redundancy of an already giant method implementation. However, they also defy convenient debugging with
my debugger (&lt;a href="https://www.gnu.org/software/gdb/">GDB&lt;/a>). As a result, I had to trace these sections by hand when
necessary. The source code also contains many short (often one or two-character) symbol names. There&amp;rsquo;s a lot of
&lt;span class="nowrap">C++&lt;/span> source code with inappropriately vague symbol names, so this isn&amp;rsquo;t a shocker. Just
like everything else I&amp;rsquo;ve mentioned, though, this makes the source code more difficult to read and, ultimately, to
debug.&lt;/p>
&lt;h2 id="the-solution">The Solution&lt;/h2>
&lt;p>To solve these problems, &lt;a href="https://github.com/gn0mesort/godot/tree/3.5">the patched version of Godot&lt;/a>
had to change both the &lt;code>Label&lt;/code> and &lt;code>RichTextLabel&lt;/code> nodes. The core of both nodes' new CJK line-breaking functionality
is the &lt;a href="https://github.com/gn0mesort/godot/blob/3.5/scene/gui/gs_cjk.h">&lt;code>gnomesort::is_cjk_x_char&lt;/code>&lt;/a> family of
functions. These functions provide a modular way for Godot scene nodes to classify CJK text. This functionality
includes simple detection (i.e., is the text CJK or not), detection of whether or not a character may end a line,
detection of whether or not a character may begin a line, and detection of whether or not a character is separable
from its neighbors.&lt;/p>
&lt;p>The separability question is particularly complex because it requires analyzing the characters before and after the
current character (if they exist). Determining separability is no big deal for &lt;code>Label&lt;/code> nodes because they always hold
their entire text. &lt;code>RichTextLabel&lt;/code> nodes are another story. For &lt;code>RichTextLabel&lt;/code> nodes, Godot needs to traverse the
internal &lt;code>Item&lt;/code> list. Besides the additional complexity of linked list traversal, which is minimal, &lt;code>RichTextLabel&lt;/code>
nodes require analyzing several characters ahead of the current character to determine the locations of safe breaking
points. This extra complexity is owed, in no small part, to the generally messier way that &lt;code>RichTextLabel&lt;/code> nodes are
processed. Even with additional context, there are still cases where &lt;code>RichTextLabel&lt;/code> nodes can produce incorrect
results.&lt;/p>
&lt;p>The final major issue arises when a &lt;code>RichTextLabel&lt;/code> mixes CJK text with Latin text. For example, this can occur when
text is written in Japanese but switches to Latin characters for a name (likely from user input). Initially, I chose
to detect which rules applied to a given text &lt;code>Item&lt;/code> within a &lt;code>RichTextLabel&lt;/code> by scanning the &lt;code>Item&lt;/code> entirely. This
strategy often works because the entire segment should use the CJK rules if there is CJK text. Problems arise when a
switch occurs across a formatting boundary. This issue can occur when text, like the name in the previous example, is
colored or has some other special formatting (e.g., bold, italics, underlining, etc.). In the name of expediency, I
ultimately chose to implement a toggleable setting that controls whether a &lt;code>RichTextLabel&lt;/code> should apply the CJK rules
to all text.&lt;/p>
&lt;h2 id="thoughts">Thoughts&lt;/h2>
&lt;p>At the end of the day, I stand by the admittedly expedient solution I arrived at. It&amp;rsquo;s rougher around the edges than I
would like, but that kept time and costs to a minimum. Better solutions exist; switching to Godot 4.0 and relying on
&lt;a href="https://docs.godotengine.org/en/stable/classes/class_textserver.html">&lt;code>TextServer&lt;/code>&lt;/a> is the most obvious example, but
it wouldn&amp;rsquo;t have been the correct answer for the client. Still, the time-constrained nature of these types of
contracts frustrates my perfectionist tendencies.&lt;/p>
&lt;p>Besides that, I wonder how using a framework like Godot impacts the economics of a project like Doomsday Paradise. The
simple analysis says it saves time and money, but this project indicates that the simple analysis of large software
frameworks is only sometimes correct. Other times, when the framework doesn&amp;rsquo;t cover all of a developer&amp;rsquo;s needs
perfectly, developers will have to expend resources on workarounds. How often is that the case, and how much do these
workarounds cost? Unfortunately, I don&amp;rsquo;t have an answer, and I haven&amp;rsquo;t been able to find much rigorous data on the
subject. My intuition is that the costs will likely be higher than they initially seem.&lt;/p>
&lt;p>The only way for me to find out is to pursue more of this type of work in the future. Working with Lemonade Flashbang
was my first experience with a commercial game project. It felt like a big step for me despite my relatively small
contribution. Before this, I had tried to work on a few of what I would describe as amateur game projects.
Unfortunately, those never really went anywhere. I still want to try for more amateur projects. However, I enjoyed
getting into Godot&amp;rsquo;s guts, and I know amateurs tend to flee the moment anyone mentions &lt;span class="nowrap">C++&lt;/span>.
Either way, I&amp;rsquo;d like to take on more work like this sooner than later.&lt;/p></description></item></channel></rss>