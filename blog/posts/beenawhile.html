<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<link rel="stylesheet" href="/css/index.css" />
		
		<title>Megatech - beenawhile</title>
	</head>
	<body>
		<div id="header"><div id="navbar" class="flex-container navbar">
	<nav class="flex-item"><a href="/">home</a></nav>
	<nav class="flex-item"><a href="/blog">blog</a></nav>
	<nav class="flex-item"><a href="/projects">projects</a></nav>
	<nav class="flex-item"><a href="mailto:gnomesort@megate.ch">contact</a></nav>
	<span class="flex-item flex-right">
		&lt;
		<noscript class="red bold" title="JavaScript is disabled">
			noscript
		</noscript>
		<span id="script-enabled" class="blue bold"
					title="JavaScript is enabled"></span>
		<script>
			document.getElementById('script-enabled').innerText = 'script';
		</script>
		&gt;
	</span>
	<script>
		let links = document.querySelectorAll("#navbar a");
		for (let link of links) {
			let regex = new RegExp(`^${link.href}/?#?$`, 'g');
			if (document.location.href.match(regex)) {
				link.href = '#';
			}
		}

		let xhr = new XMLHttpRequest(),
				url = 'https://pi.megate.ch:25443/visit';
		xhr.onload = () => {
			console.log(JSON.parse(xhr.response));
		}
		xhr.open('GET', `${url}`);
		xhr.send();
	</script>
</div>
<hr /></div>
		<div class="flex-container flex-column"><h1 id="been-a-while" class="center">Been a While</h1>
<p>It's been a while since I've written anything so I figured why not üòõ</p>
<p>School is really time-consuming even when I don't think it's particularly difficult. I'd really rather be playing games all day, or making games all day but I spend a lot of time reading anthropology text books instead. It's not that anthropology doesn't interest me, it's that the only exciting part of the last few chapters was discovering the existence of <a href="https://en.wikipedia.org/wiki/Oreopithecus">Oreopithecus bambolii</a> (most delicious of all extinct primates).</p>
<p>Other than kind of sort of studying anthropology, I've invested most of my non-video game related time into figuring out how to interact with LEDs using my Raspberry Pi. It's actually pretty easy, given the right supplies. Right now I have it set up with 4 RGB (Red, Green, Blue) LEDs and 220 Ohm resistors. I initially set it up with a single color LED (these came with the Raspberry Pi kit I bought) because that seemed less daunting (and less likely to lead to me being electrocuted). From there I set up a simple little RGB light with a button that changed its color. All of this was pretty simple to set up in C as well as ARM assembly (using wiringPi). As of today, I've set it up with a more impressive program that handles various patterns (no input yet though üò£) Here's the code for it:</p>
<h2 id="lightswitch.c">lightswitch.c</h2>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span>
<span class="pp">#include </span><span class="im">&lt;stdbool.h&gt;</span>
<span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span>
<span class="pp">#include </span><span class="im">&lt;time.h&gt;</span>
<span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span>

<span class="pp">#include </span><span class="im">&lt;wiringPi.h&gt;</span>

<span class="pp">#include </span><span class="im">&quot;gpio.h&quot;</span>

<span class="dt">void</span> all_one_color(LED**, <span class="dt">size_t</span>);
<span class="dt">void</span> every_other(LED**, <span class="dt">size_t</span>);
<span class="dt">void</span> pulse(LED**, <span class="dt">size_t</span>);
<span class="dt">void</span> pulse_with_reflection(LED**, <span class="dt">size_t</span>);
<span class="dt">void</span> print_color(LEDCOLOR);

<span class="kw">typedef</span> <span class="dt">void</span> (*PATTERN)(LED**, <span class="dt">size_t</span>);

<span class="dt">int</span> main() {
    LED **leds = calloc(<span class="dv">4</span>, <span class="kw">sizeof</span>(LED));
    PATTERN pattern = pulse_with_reflection;

    srand((<span class="dt">uint32_t</span>) time(NULL));
    wiringPiSetup();
    leds[<span class="dv">0</span>] = make_led(<span class="dv">27</span>, <span class="dv">28</span>, <span class="dv">29</span>),
    leds[<span class="dv">1</span>] = make_led(<span class="dv">11</span>, <span class="dv">31</span>, <span class="dv">26</span>),
    leds[<span class="dv">2</span>] = make_led(<span class="dv">4</span>, <span class="dv">5</span>, <span class="dv">10</span>),
    leds[<span class="dv">3</span>] = make_led(<span class="dv">15</span>, <span class="dv">16</span>, <span class="dv">1</span>);

    <span class="cf">while</span> (true) {
        pattern(leds, <span class="dv">4</span>);
        print_color(leds[<span class="dv">0</span>]-&gt;color);
        print_color(leds[<span class="dv">1</span>]-&gt;color);
        print_color(leds[<span class="dv">2</span>]-&gt;color);
        print_color(leds[<span class="dv">3</span>]-&gt;color);
        printf(<span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span>);
        fflush(stdout);
        delay(<span class="dv">200</span>);
 }

    destroy_led(leds[<span class="dv">0</span>]);
    destroy_led(leds[<span class="dv">1</span>]);
    destroy_led(leds[<span class="dv">2</span>]);
    destroy_led(leds[<span class="dv">3</span>]);

    free(leds);

    <span class="cf">return</span> <span class="dv">0</span>;
}

<span class="dt">void</span> all_one_color(LED **leds, <span class="dt">size_t</span> count) {
    LEDCOLOR color = (rand() % <span class="bn">0x7</span>) + <span class="dv">1</span>;
    <span class="cf">for</span> (<span class="dt">size_t</span> i = <span class="dv">0</span>; i &lt; count; ++i) { set_color(leds[i], color); }
}

<span class="dt">void</span> every_other(LED **leds, <span class="dt">size_t</span> count) {
    LEDCOLOR color = (rand() % <span class="bn">0x7</span>) + <span class="dv">1</span>, alt = ((color + <span class="dv">1</span>) % <span class="bn">0x7</span>) + <span class="dv">1</span>;
    <span class="cf">for</span> (<span class="dt">size_t</span> i = <span class="dv">0</span>; i &lt; count; i += <span class="dv">2</span>) {
        set_color(leds[i], color);
        set_color(leds[i + <span class="dv">1</span>], alt);
    }
}

<span class="dt">void</span> pulse(LED **leds, <span class="dt">size_t</span> count) {
    <span class="dt">static</span> <span class="dt">size_t</span> i = <span class="dv">0</span>;

    bool any = false;
    <span class="cf">if</span>(leds[i]-&gt;color != LED_OFF &amp;&amp; i + <span class="dv">1</span> &lt; count) {
        set_color(leds[i + <span class="dv">1</span>], leds[i]-&gt;color);
        clear_color(leds[i]);
        any = true;
        ++i;
    }
    <span class="cf">else</span> {
        clear_color(leds[i]);
        i = <span class="dv">0</span>;
    }
    <span class="cf">if</span> (!any) { set_color(leds[<span class="dv">0</span>], (rand() % <span class="bn">0x7</span>) + <span class="dv">1</span>); }
}

<span class="dt">void</span> pulse_with_reflection(LED **leds, <span class="dt">size_t</span> count) {
    <span class="dt">static</span> <span class="dt">size_t</span> i = <span class="dv">0</span>;
    <span class="dt">static</span> bool sign = true;

    <span class="cf">if</span>(leds[i]-&gt;color != LED_OFF) {
        <span class="cf">if</span> (sign &amp;&amp; i + <span class="dv">1</span> &lt; count) {
            set_color(leds[i + <span class="dv">1</span>], leds[i]-&gt;color); 
            clear_color(leds[i]);
            ++i;
        }
        <span class="cf">else</span> <span class="cf">if</span> (!sign &amp;&amp; i - <span class="dv">1</span> &lt; i) {
            set_color(leds[i - <span class="dv">1</span>], leds[i]-&gt;color);
            clear_color(leds[i]);
            --i;
        }
        <span class="cf">else</span> {
            set_color(leds[i], (rand() % <span class="bn">0x7</span>) + <span class="dv">1</span>);
            sign = !sign;
        }
    }
    <span class="cf">else</span> {
        set_color(leds[i], (rand() % <span class="bn">0x7</span>) + <span class="dv">1</span>);
    }

}

<span class="dt">void</span> print_color(LEDCOLOR color) {
    <span class="cf">switch</span> (color) {
        <span class="cf">case</span> <span class="bn">0x0</span>: { printf(<span class="st">&quot; &quot;</span>); <span class="cf">break</span>; }
        <span class="cf">case</span> <span class="bn">0x1</span>: { printf(<span class="st">&quot;B&quot;</span>); <span class="cf">break</span>; }
        <span class="cf">case</span> <span class="bn">0x2</span>: { printf(<span class="st">&quot;G&quot;</span>); <span class="cf">break</span>; }
        <span class="cf">case</span> <span class="bn">0x3</span>: { printf(<span class="st">&quot;C&quot;</span>); <span class="cf">break</span>; }
        <span class="cf">case</span> <span class="bn">0x4</span>: { printf(<span class="st">&quot;R&quot;</span>); <span class="cf">break</span>; }
        <span class="cf">case</span> <span class="bn">0x5</span>: { printf(<span class="st">&quot;M&quot;</span>); <span class="cf">break</span>; }
        <span class="cf">case</span> <span class="bn">0x6</span>: { printf(<span class="st">&quot;Y&quot;</span>); <span class="cf">break</span>; }
        <span class="cf">case</span> <span class="bn">0x7</span>: { printf(<span class="st">&quot;W&quot;</span>); <span class="cf">break</span>; }
        <span class="cf">default</span>: { printf(<span class="st">&quot;X&quot;</span>); }
    }
}</code></pre></div>
<h2 id="gpio.h">gpio.h</h2>
<div class="sourceCode"><pre class="sourceCode c"><code class="sourceCode c"><span class="pp">#ifndef GPIO_H</span>
<span class="pp">#define GPIO_H</span>

<span class="pp">#ifdef __cplusplus</span>

<span class="pp">#include </span><span class="im">&lt;cstdint&gt;</span>

<span class="kw">extern</span> <span class="st">&quot;C&quot;</span> {

<span class="pp">#else</span>

<span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span>

<span class="pp">#endif</span>

<span class="pp">#include </span><span class="im">&lt;wiringPi.h&gt;</span>

<span class="kw">typedef</span> <span class="kw">enum</span> {
    LED_OFF = <span class="bn">0x0</span>,
    LED_BLUE = <span class="bn">0x1</span>,
    LED_GREEN = <span class="bn">0x2</span>,
    LED_CYAN = <span class="bn">0x3</span>,
    LED_RED = <span class="bn">0x4</span>,
    LED_MAGENTA = <span class="bn">0x5</span>,
    LED_YELLOW = <span class="bn">0x6</span>,
    LED_WHITE = <span class="bn">0x7</span>
} LEDCOLOR;

<span class="kw">typedef</span> <span class="kw">struct</span> {
    LEDCOLOR color;
    <span class="dt">uint8_t</span> pins[<span class="dv">3</span>];
} LED;

<span class="kw">typedef</span> <span class="kw">struct</span> {
    <span class="dt">uint8_t</span> pin;
} BUTTON;

LED* make_led(<span class="dt">uint8_t</span>, <span class="dt">uint8_t</span>, <span class="dt">uint8_t</span>);
LED* set_color(LED*, LEDCOLOR);
LED* clear_color(LED*);
<span class="dt">void</span> destroy_led(LED*);

BUTTON* make_button(<span class="dt">uint8_t</span>);
bool read_button(BUTTON*);
<span class="dt">void</span> destroy_button(BUTTON*);

<span class="pp">#ifdef __cplusplus</span>

}

<span class="pp">#endif</span>

<span class="pp">#endif </span><span class="co">/* GPIO_H */</span></code></pre></div>
<h2 id="gpio.s">gpio.s</h2>
<pre class="armasm"><code>.global make_led
.global set_color
.global clear_color
.global destroy_led
.global make_button
.global read_button
.global destroy_button

.section .text
.balign 4

.func make_led
make_led:
    push {v1, v2, v3, v4, lr} // Push registers
    mov v1, a1 // Set v1 to a1
    mov v2, a2 // Set v2 to a2
    mov v3, a3 // Set v3 to a3

    mov a1, #8 // Set a1 to 8
    bl malloc // Call malloc(8) (or malloc(sizeof(LED)))
    mov v4, a1 // Set v4 to a1

    mov a2, #0 // Set a2 to 0
    str a2, [v4] // Store a2 into v4
    strb v1, [v4, #4] // Store v1 into the byte at v4+4
    strb v2, [v4, #5] // Store v2 into the byte at v4+5
    strb v3, [v4, #6] // Store v3 into the byte at v4+6

    mov a1, v1 // Set a1 to v1
    mov a2, #1 // Set a2 to 1
    bl pinMode // Call pinMode(this-&gt;pins[0], OUTPUT)

    mov a1, v2 // Set a1 to v2
    mov a2, #1 // Set a2 to 1
    bl pinMode // Call pinMode(this-&gt;pins[1], OUTPUT)

    mov a1, v3 // Set a1 to v3
    mov a2, #1 // Set a2 to 1
    bl pinMode // Call pinMode(this-&gt;pins[2], OUTPUT)

    mov a1, v4 // Set a1 to v4
    pop {v1, v2, v3, v4, pc} // Return
.endfunc

.func set_color
set_color:
    push {a1, v1, v2, lr} // Push registers
    mov v1, a1 // Set v1 to a1
    mov v2, a2 // Set v2 to a2

    str a2, [v1] // Store a2 into v1

    ldrb a1, [v1, #4] // Load the value of v1+4 into a1
    and a2, v2, #4 // Set a2 to the 2nd bit of v2
    bl digitalWrite // Call digitalWrite(this-&gt;pins[0], this-&gt;color &amp; 4)

    ldrb a1, [v1, #5] // Load the value of v1+5 into a1
    and a2, v2, #2 // Set a2 to the 1st bit of v2
    bl digitalWrite // Call digitalWrite(this-&gt;pins[1], this-&gt;color &amp; 2)

    ldrb a1, [v1, #6] // Load the value of v1+6 into a1
    and a2, v2, #1 // Set a2 to the 0th bit of v2
    bl digitalWrite // Call digitalWrite(this-&gt;pins[2], this-&gt;color &amp; 1)

    pop {a1, v1, v2, pc} // Return
.endfunc

.func clear_color
clear_color:
    push {lr} // Push registers

    mov a2, #0 // Set a2 to 0
    bl set_color // Call set_color(a1, LED_OFF)

    pop {pc} // Return
.endfunc

.func destroy_led
destroy_led:
    push {lr} // Push registers

    bl clear_color // Call clear_color(this) to turn off LED
    bl free // Call free(this)

    pop {pc} // Return
.endfunc

.func make_button
make_button:
    push {v1, lr} // Push registers
    mov v1, a1 // Set v1 to a1

    mov a2, #0 // Set a2 to 0
    bl pinMode // Call pinMode(a1, INPUT)

    mov a1, v1 // Set a1 to v1
    mov a2, #2 // Set a2 to 2
    bl pullUpDnControl // Call pullUpDnControl(a1, PUD_UP)

    mov a1, #4 // Set a1 to 4
    bl malloc // Call malloc(4)
    strb v1, [a1] // Store v1 into the first byte at a1

    pop {v1, pc} // Return
.endfunc

.func read_button
read_button:
    push {lr} // Push registers

    ldrb a1, [a1] // Load the value of a1 into a1
    bl digitalRead // Call digitalRead(this-&gt;pin)

    pop {pc} // Return
.endfunc

.func destroy_button
destroy_button:
    push {v1, lr} // Push registers
    mov v1, a1 // Set v1 to a1

    ldrb a1, [a1] // Load the value of a1 into a1
    mov a2, #0 // Set a2 to 0
    bl pullUpDnControl // Call pullUpDnControl(this-&gt;pin, PUD_OFF)

    mov a1, v1 // Set a1 to v1
    bl free // call free(this)

    pop {v1, pc} // Return
.endfunc</code></pre>
<p>The code might seem like gibberish so here are a few pictures and a video of it running the hardware before I explain.</p>
<p class="center">
<a href="https://pi.megate.ch:25443/blog/img/gpio_1.jpg"><img class="frame" src="https://pi.megate.ch:25443/blog/img/gpio_1_small.jpg" alt="Image 1" title="Image 1" /></a>
</p>
<p class="center">
<a href="https://pi.megate.ch:25443/blog/img/gpio_2.jpg"><img class="frame" src="https://pi.megate.ch:25443/blog/img/gpio_2_small.jpg" alt="Image 2" title="Image 2" /></a>
</p>
<p class="center">
<a href="https://pi.megate.ch:25443/blog/img/gpio_3.jpg"><img class="frame" src="https://pi.megate.ch:25443/blog/img/gpio_3_small.jpg" alt="Image 3" title="Image 3" /></a>
</p>
<div class="center">
<iframe class="frame" src="https://www.youtube-nocookie.com/embed/zQsaso_rD4s?rel=0" allowfullscreen style="max-width: 100%;max-height: 100%;" width="1280" height="720" frameborder="0">
</iframe>
</div>
<p>So what's all this stuff up to? The code is broken up into three parts. First, and obviously most important is <code>lightswitch.c</code>. It's a little C program that controls the hardware for me and implements all of my different patterns (the video only shows pulse with reflection). It's mostly just creating an array of 4 <code>LED</code>s and manipulating them using functions found in <code>gpio.h</code>. <code>gpio.h</code> for its part describes all the fancy hardware stuff. It describes the <code>LED</code> structure that I'm using as well as a <code>BUTTON</code> structure that I haven't gotten around to yet. Finally <code>gpio.s</code> does all the work for <code>gpio.h</code>. It's written in ARM assembly, not because I particularly wanted it to be but, because I plan to use it in a school project.</p>
<p>Although it's a bit tangential to the actual project I'm doing for school, I might develop <code>lightswitch.c</code> and pals a little more. Mostly just because it's fun (pretty much anything with blinky LEDs is fun). I'd certainly like to make it accept input across the buttons I have wired up. It would be neat to be able to cycle both patterns and methods of picking colors (for now all the patterns use random colors).</p>
<p>Anyways that's what I'm up to (well that and playing the new .hack//G.U. rerelease). I hope that wherever and whenever you are you're doing well. Good luck out there! üôáüèª</p></div>
		<div id="footer"><hr />
<div class="flex-container footer">
	<span class="flex-item flex-center">
		{&nbsp;
		<a href="https://github.com/gn0mesort/gn0mesort.github.io/">Source Code</a>
		&nbsp;}
	</span>
</div></div>
	</body>
</html>