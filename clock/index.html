<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../css/default.css" type="text/css" />
    <link rel="stylesheet" href="../css/megatech.css" type="text/css" />
    <link rel="icon" href="../img/favicon.png" />
    <title>Clock - メガテクボディ合同会社</title>
  </head>
  <body style="background-image:url('../img/background.jpg')">
    <div class="navbar"></div>
    <div class="space"></div>
    <div class="container green">
      <div class="column column-one">
        <div class="content-box">
          <h1 id="clock">Loading...</h1>
        </div>
        <div class="space"></div>
      </div>
    </div>
    <div class="container green">
      <div class="column column-one">
        <div class="content-box">
          <label>Time:</label>
          <input id="hour" class="green" type="text" size="2" pattern="[0-1][0-9]" name="hour" min="1" max="12" value="1" onchange="stopped(false);setAlarmDate()"></input>
          <input id="minute" class="green" type="text" size="2" pattern="[0-5][0-9]" name="minute" min="0" max="59" value="00" onchange="stopped(false);setAlarmDate()"></input>
          <select id="ampm" class="green" onchange="stopped(false);setAlarmDate();">
            <option value="am">AM</option>
            <option value="pm">PM</option>
          </select>
          <br />
          <label>Alarm:</label>
          <select id="track" class="green" onchange="setAlarm(this.options[this.selectedIndex])" onload="setAlarm(this.options[this.selectedIndex]);stopped(false)">
            <option value="Alarm01.wav" selected="">Alarm 1</option>
            <option value="Alarm02.wav">Alarm 2</option>
            <option value="Alarm03.wav">Alarm 3</option>
            <option value="Alarm04.wav">Alarm 4</option>
            <option value="Alarm05.wav">Alarm 5</option>
            <option value="Alarm06.wav">Alarm 6</option>
            <option value="Alarm07.wav">Alarm 7</option>
            <option value="Alarm08.wav">Alarm 8</option>
            <option value="Alarm09.wav">Alarm 9</option>
            <option value="Alarm10.wav">Alarm 10</option>
          </select>
          <audio id="alarm" loop="" controls="" style="vertical-align: middle;" onpause="stopped(true)" onplay="stopped(false)">
            <source id="alarm-source" src="../media/audio/Alarm01.wav" type="audio/wav" />
          </audio>
          <label>Active:</label>
          <input id="active" type="checkbox" value="true" onchange="stopped(!this.checked)"></input>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="../js/index.js"></script>
    <script>
      var m = new Megatech()
      $('div[class="navbar"]').load('../html/navbar.html', function() {
        var navbar = $('div[class="navbar"]')[0]
        m.handleNavBar(navbar)
      })

      var setAlarm = function (option) {
        document.getElementById('alarm-source').src = '../media/audio/' + option.value
        document.getElementById('alarm').load()
      }

      var stopped = function(stop) {
        if(this._stopped === undefined) { this._stopped = false }
        if(stop !== undefined) { this._stopped = stop }
        document.getElementById('active').checked = !this._stopped
        return this._stopped
      }

      var setAlarmDate = function () {
        var date = new Date()
        this._alarmDate = new Date()
        var ampm = document.getElementById('ampm').value === 'am' ? true : false
        this._alarmDate.setHours(Number(document.getElementById('hour').value))
        this._alarmDate.setMinutes(Number(document.getElementById('minute').value))
        this._alarmDate.setSeconds(0)
        this._alarmDate.setMilliseconds(0)
         if (!ampm) {  this._alarmDate.setHours(this._alarmDate.getHours() + 12) % 24 }
        else if (ampm && this._alarmDate.getHours() === 12) { this._alarmDate.setHours(0) }
        if(ampm && this._alarmDate.getHours() > date.getHours()) { this._alarmDate.setDate(this._alarmDate.getDate() + 1) }
      }

      setAlarm(document.getElementById("track").selectedOptions[0])
      setAlarmDate()

      setInterval(function () {
        var date = new Date()
        var alarm = document.getElementById('alarm')
        $('#clock').html(date.toLocaleDateString() + '<br />' + date.toLocaleTimeString())
        if (!stopped() && date >= this._alarmDate) { alarm.play() }
        else if (stopped() || date <= this._alarmDate) { alarm.pause() }
      }, 1000)
    </script>
  </body>
</html>